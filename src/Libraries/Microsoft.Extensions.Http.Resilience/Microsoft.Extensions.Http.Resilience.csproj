<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <RootNamespace>Microsoft.Extensions.Http.Resilience</RootNamespace>
    <Description>Resilience mechanisms for HttpClient.</Description>
    <Workstream>Resilience</Workstream>
  </PropertyGroup>

  <PropertyGroup>
    <EnableConfigurationBindingGenerator>true</EnableConfigurationBindingGenerator>
    <UseLoggingGenerator>true</UseLoggingGenerator>
    <UseMetricsGenerator>true</UseMetricsGenerator>
    <InjectSharedNumericExtensions>true</InjectSharedNumericExtensions>
    <InjectSharedThrow>true</InjectSharedThrow>
    <InjectDiagnosticAttributesOnLegacy>true</InjectDiagnosticAttributesOnLegacy>
    <InjectTrimAttributesOnLegacy>true</InjectTrimAttributesOnLegacy>
    <InjectSharedDataValidation>true</InjectSharedDataValidation>
    <InjectSharedPools>true</InjectSharedPools>
    <InjectSharedDiagnosticIds>true</InjectSharedDiagnosticIds>
    <InjectExperimentalAttributeOnLegacy>true</InjectExperimentalAttributeOnLegacy>
  </PropertyGroup>

  <PropertyGroup>
    <Stage>normal</Stage>
    <MinCodeCoverage>97</MinCodeCoverage>
    <MinMutationScore>100</MinMutationScore>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="..\Microsoft.Extensions.Resilience\Microsoft.Extensions.Resilience.csproj" />
    <ProjectReference Include="..\Microsoft.Extensions.Http.Diagnostics\Microsoft.Extensions.Http.Diagnostics.csproj" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.Extensions.Configuration.Binder" />
  </ItemGroup>

  <ItemGroup>
    <InternalsVisibleToTest Include="$(AssemblyName).Tests" />
    <InternalsVisibleToDynamicProxyGenAssembly2 Include="*" />
  </ItemGroup>

  <ItemGroup>
    <None Include="buildTransitive\$(MSBuildProjectName).*"
          CopyToOutputDirectory="PreserveNewest"
          Pack="true"
          PackagePath="buildTransitive\$(MinimumSupportedTfmForPackaging)\" />
    
    <!-- For net462 we copy only .props file. The .targets file is added automatically by the build process, and the code
         that checks the version of the Grpc.Net.ClientFactory package will be added to the .targets file as a value
         of the _AdditionalNETStandardCompatErrorFileContents variable. -->
    <None Include="buildTransitive\$(MSBuildProjectName).props"
          CopyToOutputDirectory="PreserveNewest"
          Pack="true"
          PackagePath="buildTransitive\net462\" />
  </ItemGroup>

  <!-- For net462 we automatically add the .targets file, and to include the code that checks the version of the
       Grpc.Net.ClientFactory package we need to set the _AdditionalNETStandardCompatErrorFileContents variable. -->
  <PropertyGroup>
    <_AdditionalNETStandardCompatErrorFileContents>
      <![CDATA[
  <!--
    Check whether the project is referencing Grpc.Net.ClientFactory 2.64.0 or later.
    If the vesion is earlier warn the user to update.
    See https://github.com/dotnet/extensions/tree/main/src/Libraries/Microsoft.Extensions.Http.Resilience#known-issues for more details.
    -->
  <Target Name="_CheckGrpcNetClientFactoryVersion"
          BeforeTargets="ResolveReferences"
          Condition=" '%24(SuppressCheckGrpcNetClientFactoryVersion)' != 'true' ">
    <ItemGroup>
      <!-- Find the package in the .csproj file. -->
      <_GrpcNetClientFactoryPackageReference Include="%40(PackageReference)" Condition=" '%(PackageReference.Identity)' == '%24(_GrpcNetClientFactory)' " />

      <!-- Find the version of the package in the Central Package Source. The solution uses the Central Package Management. -->
      <_GrpcNetClientFactoryPackageVersion Include="%40(PackageVersion)" Condition=" '%(PackageVersion.Identity)' == '%24(_GrpcNetClientFactory)' " />
      
      <!-- The package is added to the project as a transitive dependency. -->
      <_GrpcNetClientFactoryTransitiveDependency Include="%40(ReferencePath)" Condition=" '%(ReferencePath.NuGetPackageId)' == '%24(_GrpcNetClientFactory)' " />
    </ItemGroup>

    <!-- The version of the package is included in the .csproj file. -->
    <Error Condition=" %40(_GrpcNetClientFactoryPackageReference->Count()) &gt%3B 0
                       AND '%(_GrpcNetClientFactoryPackageReference.Version)' != ''
                       AND %24([MSBuild]::VersionLessThan('%(_GrpcNetClientFactoryPackageReference.Version)', '%24(_CompatibleGrpcNetClientFactoryVersion)')) "
           Text="%24(_GrpcNetClientFactoryVersionIsIncorrect)" />

    <!-- The solution uses the Central Package Management and the version of the package is overridden in the .csproj file using the VersionOverride property. -->
    <Error Condition=" '%24(ManagePackageVersionsCentrally)' == 'true'
                       AND %40(_GrpcNetClientFactoryPackageReference->Count()) &gt%3B 0
                       AND '%(_GrpcNetClientFactoryPackageReference.VersionOverride)' != ''
                       AND %24([MSBuild]::VersionLessThan('%(_GrpcNetClientFactoryPackageReference.VersionOverride)', '%24(_CompatibleGrpcNetClientFactoryVersion)')) "
           Text="%24(_GrpcNetClientFactoryVersionIsIncorrect)" />

    <!-- The solution uses the Central Package Management and the version of the package is included in the Central Package Source. -->
    <Error Condition=" '%24(ManagePackageVersionsCentrally)' == 'true'
                       AND %40(_GrpcNetClientFactoryPackageReference->Count()) &gt%3B 0
                       AND '%(_GrpcNetClientFactoryPackageVersion.Version)' != ''
                       AND %24([MSBuild]::VersionLessThan('%(_GrpcNetClientFactoryPackageVersion.Version)', '%24(_CompatibleGrpcNetClientFactoryVersion)')) "
           Text="%24(_GrpcNetClientFactoryVersionIsIncorrect)" />

    <!-- This condition handles a case when the package is added to the project as a transitive dependency. -->
    <Error Condition=" %40(_GrpcNetClientFactoryTransitiveDependency->Count()) &gt%3B 0
                       AND '%(_GrpcNetClientFactoryTransitiveDependency.NuGetPackageVersion)' != ''
                       AND %24([MSBuild]::VersionLessThan('%(_GrpcNetClientFactoryTransitiveDependency.NuGetPackageVersion)', '%24(_CompatibleGrpcNetClientFactoryVersion)')) "
           Text="%24(_GrpcNetClientFactoryVersionIsIncorrect)" />
  </Target>
]]>
    </_AdditionalNETStandardCompatErrorFileContents>
  </PropertyGroup>
</Project>
