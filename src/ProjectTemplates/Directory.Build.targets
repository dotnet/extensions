<Project>
  <Import Project="$([MSBuild]::GetPathOfFileAbove('Directory.Build.targets', '$(MSBuildThisFileDirectory)../'))" />

  <Target Name="_ResolveTemplatePackageProjectVersions">
    <!--
      Target "GetProjectPackageVersion" is defined in /eng/MSBuild/Packaging.targets
      and imported by all packable projects.

      Build all projects references to get their PackageId and PackageVersion values,
      running only that target against the latest TFM. No other targets are executed.
    -->
    <MSBuild Projects="@(ProjectReference)" Targets="GetProjectPackageVersion"
             SkipNonexistentTargets="true" SkipNonexistentProjects="true"
             Properties="TargetFramework=$(LatestTargetFramework)">
      <Output TaskParameter="TargetOutputs" ItemName="_ResolvedTemplatePackageProjectVersion" />
    </MSBuild>
  </Target>

  <Target Name="_ResolveTemplatePackageVersions" DependsOnTargets="_ResolveTemplatePackageProjectVersions">
    <ItemGroup>
      <!-- Seed the list with all <ProjectReference> package versions -->
      <_ResolvedTemplatePackageVersion Include="@(_ResolvedTemplatePackageProjectVersion)" />

      <!-- Override with the any <PackageVersion> items -->
      <_ResolvedTemplatePackageVersion Remove="@(PackageVersion)" />
      <_ResolvedTemplatePackageVersion Include="@(PackageVersion)" />
    </ItemGroup>
  </Target>

  <Target Name="_ResolveTemplateContentPaths">
    <PropertyGroup>
      <_GeneratedContentDir>$([System.IO.Path]::Combine($(ProjectTemplateArtifactsDir), $(PackageId), 'GeneratedContent'))</_GeneratedContentDir>
    </PropertyGroup>

    <ItemGroup>
      <_TemplateContentFile Include="@(TemplateContent)">
        <OutputFileName Condition="'%(TemplateContent.ChangeExtension)' == ''">%(FileName)%(TemplateContent.Extension)</OutputFileName>
        <OutputFileName Condition="'%(TemplateContent.ChangeExtension)' != ''">%(FileName)%(TemplateContent.ChangeExtension)</OutputFileName>

        <PackagePathRoot Condition="'%(TemplateContent.PackagePath)' == ''">$([System.IO.Path]::Combine("content", %(TemplateContent.RelativeDir)))</PackagePathRoot>
        <PackagePathRoot Condition="'%(TemplateContent.PackagePath)' != ''">%(TemplateContent.PackagePath)</PackagePathRoot>
      </_TemplateContentFile>

      <_ResolvedTemplateContent Include="@(_TemplateContentFile)">
        <ArtifactPath>$([System.IO.Path]::Combine($(_GeneratedContentDir), %(_TemplateContentFile.RelativeDir), %(_TemplateContentFile.OutputFileName)))</ArtifactPath>
        <PackagePath>$([System.IO.Path]::Combine(%(_TemplateContentFile.PackagePathRoot), %(_TemplateContentFile.RecursiveDir), %(_TemplateContentFile.OutputFileName)))</PackagePath>
      </_ResolvedTemplateContent>
    </ItemGroup>
  </Target>

  <!-- Invoke this target before 'Build' for all template projects -->
  <Target Name="_GenerateTemplateContent" BeforeTargets="Build"
          DependsOnTargets="_ResolveTemplatePackageVersions;_ResolveTemplateContentPaths">

    <!--
      Template projects define <TemplateContent> items to pre-process for token replacements,
      including <ProjectReference> and <PackageVersion> items that define package version replacements.

      All template content files are output into the project's <Content> to ensure the output
      files are added to the template package, and the PackagePath is set to respect ** RecursiveDir
      values to align with <Content> item behavior.
    -->
    <ItemGroup>
      <_TemplatePackageVersionProperty
        Include="@(_ResolvedTemplatePackageVersion->'PackageVersion:%(Identity)=%(Version)')" />
    </ItemGroup>

    <PropertyGroup>
      <!--
        Existing GeneratedContentProperties plus all template package
        version properties, separated by semicolons (and newlines for readability).
      -->
      <GeneratedContentProperties>
        $(GeneratedContentProperties);
        @(_TemplatePackageVersionProperty, ';%0A');
      </GeneratedContentProperties>
    </PropertyGroup>

    <!-- Also support any <TemplateContent> item specifying AdditionalProperties -->
    <GenerateFileFromTemplate
      TemplateFile="%(_ResolvedTemplateContent.Identity)"
      Properties="$(GeneratedContentProperties);%(_ResolvedTemplateContent.AdditionalProperties)"
      OutputPath="%(_ResolvedTemplateContent.ArtifactPath)" />

    <ItemGroup>
      <!-- Add the generated files into the template package -->
      <Content Include="@(_ResolvedTemplateContent->Metadata('ArtifactPath')->ClearMetadata())">
        <PackagePath>%(_ResolvedTemplateContent.PackagePath)</PackagePath>
      </Content>
    </ItemGroup>
  </Target>

  <Target Name="_CleanProjectTemplates" BeforeTargets="Clean">
    <!-- Delete the GeneratedContent, Sandbox, and Snapshots artifacts folders when cleaning the template project -->
    <RemoveDir Directories="$([System.IO.Path]:Combine($(ProjectTemplateArtifactsDir), $(PackageId)))" />
  </Target>
</Project>
