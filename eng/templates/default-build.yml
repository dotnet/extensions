# default-build.yml
#
# Description: Defines a build phase for invoking build.sh/cmd
#
# Parameters:
#   configuration: string
#       Release or Debug
#   agentOs: string
#       Used in templates to define variables which are OS specific. Typically from the set { Windows, Linux, macOS }
#   buildArgs: string
#       Additional arguments to pass to the build.sh/cmd script.
#       Note: -ci is always passed
#   artifacts:
#      publish: boolean
#           Should artifacts be published
#      path: string
#           The file path to artifacts output
#      name: string
#           The name of the artifact container
#   codeSign: boolean
#       This build definition is enabled for code signing. (Only applies to Windows)

#
# See https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&tabs=schema
#

parameters:
  agentOs: 'Windows'
  poolName: ''
  buildArgs: ''
  configuration: 'Release'
  codeSign: false
  artifacts:
    publish: false
    name: ''
    path: 'artifacts/'

jobs:
- job: ${{ parameters.agentOs }}
  workspace:
    clean: all
  # Map friendly OS names to the right queue
  # See https://github.com/dotnet/arcade/blob/master/Documentation/ChoosingAMachinePool.md
  pool:
    ${{ if ne(parameters.poolName, '') }}:
      name: ${{ parameters.poolName }}
    ${{ if and(eq(parameters.poolName, ''), eq(parameters.agentOs, 'Windows')) }}:
      vmImage: windows-2019
      ${{ if ne(variables['System.TeamProject'], 'public') }}:
        # This override makes the specified vmImage irrelevant.
        name: NetCore1ESPool-Svc-Internal
        demands: ImageOverride -equals 1es-windows-2019
  variables:
    AgentOsName: ${{ parameters.agentOs }}
    ASPNETCORE_TEST_LOG_MAXPATH: "200" # Keep test log file name length low enough for artifact zipping
    DOTNET_HOME: $(Agent.WorkFolder)/.dotnet
    BuildScriptArgs: ${{ parameters.buildArgs }}
    BuildConfiguration: ${{ parameters.configuration }}
    LC_ALL: 'en_US.UTF-8'
    LANG: 'en_US.UTF-8'
    LANGUAGE: 'en_US.UTF-8'
    VSTS_OVERWRITE_TEMP: false # Workaround for https://github.com/dotnet/core-eng/issues/2812
    ${{ if or(ne(parameters.codeSign, 'true'), ne(variables['System.TeamProject'], 'internal')) }}:
      _SignType:
    ${{ if and(eq(parameters.codeSign, 'true'), eq(variables['System.TeamProject'], 'internal')) }}:
      TeamName: AspNetCore
      ${{ if in(variables['Build.Reason'], 'PullRequest') }}:
        _SignType: test
      ${{ if notin(variables['Build.Reason'], 'PullRequest') }}:
        _SignType: real
        # Enable CodeQL3000 auto-injected tasks. These tasks will no-op if two builds run w/in the same week.
        Codeql.Cadence: 168
        # Enable CodeQL3000 unconditionally so it may be run on any branch.
        Codeql.Enabled: true
        # Ignore infrastructure code.
        Codeql.SourceRoot: src
        # CodeQL3000 needs this plumbed along as a variable to enable TSA.
        Codeql.TSAEnabled: true
        # Default expects tsaoptions.json under SourceRoot.
        Codeql.TSAOptionsPath: '$(Build.SourcesDirectory)/.config/tsaoptions.json'
    ${{ if eq(variables['System.TeamProject'], 'public') }}:
      PB_PackageVersionPropsUrl: ''
      PB_AssetRootUrl: ''
      PB_RestoreSource: ''
  steps:
  - checkout: self
    clean: true
  - ${{ if eq(parameters.agentOs, 'Windows') }}:
    - task: NuGetCommand@2
      displayName: 'Clear NuGet caches'
      condition: succeeded()
      inputs:
        command: custom
        arguments: 'locals all -clear'
  - ${{ if and(eq(variables['System.TeamProject'], 'internal'), eq(parameters.agentOs, 'Windows'), eq(parameters.codeSign, 'true')) }}:
    - task: MicroBuildSigningPlugin@2
      displayName: Install MicroBuild Signing plugin
      condition: and(succeeded(), in(variables['_SignType'], 'test', 'real'))
      inputs:
        signType: $(_SignType)
        zipSources: false
        feedSource: https://dnceng.pkgs.visualstudio.com/_packaging/MicroBuildToolset/nuget/v3/index.json
    - ${{ if notin(variables['Build.Reason'], 'PullRequest') }}:
      # CodeQL3000 tasks can be auto-injected but only in builds of a repo's default branch. Be explicit here.
      - task: CodeQL3000Init@0
        displayName: CodeQL Initialize
      - script: "echo ##vso[build.addbuildtag]CodeQL3000"
        displayName: 'Set CI CodeQL3000 tag'
        condition: ne(variables.CODEQL_DIST,'')

  - ${{ if eq(parameters.agentOs, 'Windows') }}:
    - script: .\build.cmd -ci /p:SignType=$(_SignType) /p:Configuration=$(BuildConfiguration) /bl:build.binlog $(BuildScriptArgs)
      env:
        PB_PackageVersionPropsUrl: $(PB_PackageVersionPropsUrl)
        PB_AssetRootUrl: $(PB_AssetRootUrl)
        PB_RestoreSource: $(PB_RestoreSource)
      displayName: Run build.cmd
    - powershell: eng\scripts\KillProcesses.ps1
      displayName: Kill processes
      condition: always()

    - ${{ if and(eq(variables['System.TeamProject'], 'internal'), notin(variables['Build.Reason'], 'PullRequest')) }}:
      - task: CodeQL3000Finalize@0
        displayName: CodeQL Finalize
    - powershell: Move-Item build.binlog artifacts/logs/
      displayName: Move binary log into artifacts/logs/
      condition: always()
      continueOnError: true
  - task: PublishTestResults@2
    displayName: Publish test results
    condition: always()
    continueOnError: true
    inputs:
      testRunTitle: $(AgentOsName)-$(BuildConfiguration)
      testRunner: vstest
      testResultsFiles: 'artifacts/logs/**/*.trx'
      mergeTestResults: true
  - ${{ if eq(parameters.artifacts.publish, 'true') }}:
    - task: PublishBuildArtifacts@1
      displayName: Upload artifacts
      condition: always()
      continueOnError: true
      inputs:
        ${{ if eq(variables['system.pullrequest.isfork'], false) }}:
          pathtoPublish: ${{ parameters.artifacts.path }}
        ${{ else }}:
          pathtoPublish: ${{ format('{0}logs/', parameters.artifacts.path) }}
        ${{ if eq(parameters.artifacts.name, '') }}:
          artifactName: artifacts-$(AgentOsName)-$(BuildConfiguration)
        ${{ if ne(parameters.artifacts.name, '') }}:
          artifactName: ${{ parameters.artifacts.name }}
        artifactType: Container
        parallel: true
  - ${{ if and(eq(variables['System.TeamProject'], 'internal'), eq(parameters.agentOs, 'Windows')) }}:
    - task: MicroBuildCleanup@1
      displayName: Cleanup MicroBuild tasks
      condition: always()
      continueOnError: true
  - ${{ if and(eq(variables['System.TeamProject'], 'internal'), notin(variables['Build.Reason'], 'PullRequest')) }}:
      - task: ComponentGovernanceComponentDetection@0
        continueOnError: true
