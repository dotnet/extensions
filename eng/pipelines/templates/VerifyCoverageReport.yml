steps:

  # This downloads Windows_cobertura.xml from Windows_CodeCoverageResults artifact to the root of the repo
  - task: DownloadPipelineArtifact@2
    displayName: Download Windows code coverage reports
    inputs:
      buildType: 'current'
      artifactName: Windows_CodeCoverageResults
      itemPattern: '*_cobertura.xml'
      targetPath: $(Build.SourcesDirectory)

  # This downloads Ubuntu_cobertura.xml from Ubuntu_CodeCoverageResults artifact to the root of the repo
  - task: DownloadPipelineArtifact@2
    displayName: Download Ubuntu code coverage reports
    inputs:
      buildType: 'current'
      artifactName: Ubuntu_CodeCoverageResults
      itemPattern: '*_cobertura.xml'
      targetPath: $(Build.SourcesDirectory)

  # Merge the downloaded files (Windows_cobertura.xml and Ubuntu_cobertura.xml) as one (merged.cobertura.xml)
  - script: $(Build.SourcesDirectory)/.dotnet/dotnet dotnet-coverage merge
            $(Build.SourcesDirectory)/*_cobertura.xml
            --output-format cobertura
            --output $(Build.SourcesDirectory)/merged.cobertura.xml
    displayName: Merge code coverage reports

  - task: PublishCodeCoverageResults@2
    displayName: Publish unified coverage report
    inputs:
      summaryFileLocation: $(Build.SourcesDirectory)/merged.cobertura.xml
      pathToSources: $(Build.SourcesDirectory)

  - pwsh: |
        $(Build.SourcesDirectory)/eng/scripts/ValidateProjectCoverage.ps1 -CoberturaReportXml $(Build.SourcesDirectory)/merged.cobertura.xml
    displayName: Check per-project coverage

  - ${{ if and(eq(variables['System.TeamProject'], 'public'), eq(variables['Build.Reason'], 'PullRequest')) }}:
    - task: GitHubComment@0
      condition: always()
      inputs:
        gitHubConnection: dotnet-comment-bot-service-connection
        repositoryName: '$(Build.Repository.Name)'
        id: $(System.PullRequest.PullRequestNumber)
      displayName: Report coverage to GitHub
      continueOnError: 'true' # Avoid failing the build if the GitHub comment posting failed
